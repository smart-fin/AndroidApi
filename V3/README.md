# API для взаимодействия с Мобильным терминалом 2can

API предназначено для интеграции вашего мобильного приложения и Мобильного терминала 2can

## Основной сценарий использования

1. Ваше мобильное приложение передает Мобильному терминалу 2can назначение и сумму платежа
2. Мобильный терминал 2can проводит операцию с платежной картой
3. Мобильный терминал 2can возвращает результат операции и передает управление обратно вашему приложению

## Что здесь?

Здесь находится исходный код приложения, демонстрирующий возможности API.

Если на вашем телефоне установлен и активирован
Мобильный терминал 2can, то демо-приложение вызовет его для проведения операции. 

## Версии Мобильного терминала 2can, поддерживающие данное API

- 2can Касса https://play.google.com/store/apps/details?id=ru.toucan.ecommerce

## Контакты и ресурсы

- Сайт проекта: http://www.2can.ru
- Адрес службы поддержки: android-support@smart-fin.ru

## Описание API
##### Пример формирования и отправки запроса
```java
Intent intent = new Intent("ACTION");
intent.putExtra("Param1", Param1);
intent.putExtra("Param2", Param2);
...
intent.putExtra("ParamN", ParamN);
startActivityForResult(intent, ACTION_RESULT_CODE);
```
OPEN_RESULT_CODE - requestCode, см. описание методов [startActivityForResult]( https://developer.android.com/reference/android/app/Activity.html#startActivityForResult(android.content.Intent,%20int) ) и [onActivityResult]( https://developer.android.com/reference/android/app/Activity.html#onActivityResult(int,%20int,%20android.content.Intent) )

##### Получение ответа

Для получения ответа необходимо переопределить метод 
```java
void onActivityResult(int requestCode, int resultCode, Intent data)
```
resultCode - Код ответа

Для некоторых действий возвращается дополнительный объект result instanceof Parcelable. 
```java
if (intent.hasExtra("result")) {
     ParcelableObject result = intent.getParcelableExtra(Extras.result);

     if (result instanceof ru.toucan.api.APIPaymentResult) {
          // we got result, ru.toucan.api.APIPaymentResult instanceof ParcelableObject
     }
}
```

```java
public abstract class ParcelableObject implements Parcelable {
    public ParcelableObject(Parcel source) {
        try {
            String sourceJson = source.readString();
        
            Object readValue = getJsonObject(); // get json object
        
            //init all filds for this object
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
     @Override
    public void writeToParcel(Parcel dest, int flags) {
        try {
            String destJson = getJsonObject();
            
            dest.writeString(destJson);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    ...
}
```
```java
public class APIPaymentResult extends ParcelableObject {

    // Идентификатор платежа
    public Integer Payment;

    // Код авторизации
    public String AuthorizationCode;

    // Полная информация о платеже (необязательное поле)
    public PaymentDetailApi3 PaymentInfo;
}
```
См. подробное описание объектов [ru.toucan.api] (http://github.com/smart-fin/AndroidApi/tree/master/V3/src/ru/toucan/api/)

### 1. ru.toucan.OPEN
Проверяет наличие подключенного ридера к мобильному терминалу. 

##### Параметры запроса
Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный

### 2. ru.toucan.CLOSE
После проведения платежа по карте существует возможность закрытия мобильного терминала с целью уменьшения потребления ресурсов устройства.

##### Параметры запроса
Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный

### 3. ru.toucan.PAYMENT
Оплата картой

Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный
Amount | int | сумма платежа в МДЕ (в копейках) - целочисленный формат | обязательный
Desc | String | назначение платежа | обязательный
FullDescription | String | подробное назначение платежа, используется для печати подробной информации об услуге на кассовом чеке | не обязательный
ValueAddedTaxRate | String | НДС (в промилях) | не обязательный
ReceiptNumber | Номер чека | не обязательный
GetPayInfo | int | переключатель показывающий надо ли возвращать полную информацию о платеже (1-да, 2-нет)| не обязательный
FiscalizationFlag | int | Необходимость фискализации (0 - фискализация нужна(значение по-умолчанию), 1-фискализация не нужна) | не обязательный

### 4. ru.toucan.CASH_PAYMENT
Оплата наличными

Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный
Amount | int | сумма платежа в МДЕ (в копейках) - целочисленный формат | обязательный
Desc | String | назначение платежа | обязательный
FullDescription | String | подробное назначение платежа, используется для печати подробной информации об услуге на кассовом чеке | не обязательный
ValueAddedTaxRate | String | НДС (в промилях) | не обязательный
ReceiptNumber | Номер чека | не обязательный
GetPayInfo | int | переключатель показывающий надо ли возвращать полную информацию о платеже (1-да, 2-нет)| не обязательный
FiscalizationFlag | int | Необходимость фискализации (0 - фискализация нужна(значение по-умолчанию), 1-фискализация не нужна) | не обязательный

### 5. ru.toucan.VIEW_PAYMENT
Просмотр детализации платежа

Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный
Payment | int | ID платежа | обязательный

### 6. ru.toucan.CANCEL_PAYMENT
Отмена платежа по платежной карте. 
Если происходит отмена платежа, то система вызывает метод отмены платежа, передавая во входных параметрах сумму, которая была указана для списания с карты, код RRN операции, по которой совершается отмена. Приложение в ответ возвращает результат выполнения функции или текст ошибки (если нужно).

Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный
Payment | int | ID платежа | обязательный
Amount | int | сумма платежа в МДЕ (в копейках) - целочисленный формат | обязательный
RRNCode | String | RRN | обязательный
GetPayInfo | int | переключатель показывающий надо ли возвращать полную информацию о платеже (1-да, 2-нет)| не обязательный
FiscalizationFlag | int | необходимость фискализации (0 - фискализация нужна(значение по-умолчанию), 1-фискализация не нужна) | не обязательный

### 7. ru.toucan.RETURN_PAYMENT
Возврат платежа по платежной карте.
При возврате платежа система вызывает метод возврата платежа, передавая во входном параметре сумму к возврату на карту, код RRN операции, по которой совершается возврат. Приложение в ответ возвращает результат выполнения функции, маскированный номер считанной карты, другие параметры сформированной транзакции или текст ошибки (если нужно)

Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный
Payment | int | ID платежа | обязательный
Amount | int | сумма возврата в МДЕ (в копейках) - целочисленный формат | обязательный
Reason | String | Причина возврата | обязательный
SecureCardNumber | String | Безопасный номер карты | обязательный
RRNCode | String | RRN | обязательный
ReceiptNumber | Номер чека | не обязательный
GetPayInfo | int | переключатель показывающий надо ли возвращать полную информацию о платеже (1-да, 2-нет)| не обязательный
FiscalizationFlag | int | Необходимость фискализации (0 - фискализация нужна(значение по-умолчанию), 1-фискализация не нужна) | не обязательный

### 8. ru.toucan.SETTLEMENT
Получение итогов дня по картам.
Операция сверки итогов, как правило, выполняется при закрытии кассовой смены. В случае, если используется «Касса.Мобильная», самостоятельно реализующая печать чека – выполняет печать чека. Иначе же, если используется «Мобильный терминал» и печать чека осуществляется на отдельно подключенном к системе фискальном регистраторе, метод возвращает текст слип чека для печати. 

Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный
 

### 9. ru.toucan.GET_PARAMETERS
Получение списка настраиваемых параметров .
Данный метод должен предоставлять возможность стороннему мобильному приложению получить список обязательных для всех предоставляемых методов входных параметров. Возвращает XML-строку, описывающую данные параметры.
 
Имя параметра|Тип|Описание|Обязательный или нет
-------------|---|--------|-------------------
PackageName | String | имя пакета вашего приложения | обязательный
SecureCode | String | код доступа к Мобильному терминалу, при отсутствии в параметрах запроса будет запрошен у пользователя | не обязательный
DateTimeFrom | String | Дата и время начала периода, формат yyyy-MM-ddHH:mm:ss| обязательный
DateTimeTill | String | Дата и время окончания периода, формат yyyy-MM-ddHH:mm:ss| обязательный
